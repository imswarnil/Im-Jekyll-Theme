{% comment %} The plugin provides page.Paginator object {% endcomment %}
{% assign Paginator = page.Paginator %}

<section class="section">
    <div class="container">
        <h1 class="title">{{ page.title }}</h1>
        <hr>

        <!-- Search and Filter Section (Same as your original, applies to items on THIS page) -->
        <div class="box">
            <div class="columns is-vcentered">
                <!-- Search Box -->
                <div class="column is-half">
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input" type="text" id="search-input" placeholder="Search items on this page...">
                        </div>
                        <div class="control">
                            <button class="button is-info" id="search-button">
                                <span class="icon"><i class="fas fa-search"></i></span>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Author Filter -->
                <div class="column">
                    <div class="field">
                        <label class="label">Filter by Author</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="author-filter">
                                    <option value="all">All Authors</option>
                                    {% assign authors = Paginator.docs | map: 'author' | compact | uniq | sort %}
                                    {% for author in authors %}
                                    <option value="{{ author | slugify }}">{{ author }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Category Filter -->
                <div class="column">
                    <div class="field">
                        <label class="label">Filter by Category</label>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <select id="category-filter">
                                    <option value="all">All Categories</option>
                                    {% assign categories_list = Paginator.docs | map: 'categories' | compact | join: ',' | split: ',' | uniq | sort %}
                                    {% for category in categories_list %}{% assign cat_clean = category | strip %}{% if cat_clean != "" %}
                                    <option value="{{ cat_clean | slugify }}">{{ cat_clean }}</option>
                                    {% endif %}{% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tag Cloud -->
            <div class="field">
                <label class="label">Filter by Tags</label>
                <div class="tags" id="tag-cloud">
                    {% assign all_tags_list = Paginator.docs | map: 'tags' | compact | join: ',' | split: ',' | uniq | sort %}
                    {% for tag in all_tags_list %}{% assign tag_clean = tag | strip %}{% if tag_clean != "" %}
                    <span class="tag is-rounded is-medium tag-filter" data-tag="{{ tag_clean | slugify }}">
                        {{ tag_clean }} <span class="tag-count">({{ Paginator.docs | where_exp: "doc", "doc.tags contains tag_clean" | size }})</span>
                    </span>
                    {% endif %}{% endfor %}
                </div>
            </div>
        </div>

        <!-- Item List -->
        <div id="item-list" class="columns is-multiline">
            {% if Paginator.docs.size > 0 %}
            {% for item in Paginator.docs %}
            <div class="column is-4 item-card"
                 data-author="{{ item.author | default: '' | slugify }}"
                 data-category="{% for cat in item.categories %}{{ cat | strip | slugify }} {% endfor %}"
                 data-tags="{% for tag in item.tags %}{{ tag | strip | slugify }} {% endfor %}"
                 data-search="{{ item.title | default: '' | downcase }} {{ item.description | default: '' | downcase }} {{ item.content | strip_html | downcase }}">
                <div class="card">
                    {% if item.image %}
                    <div class="card-image">
                        <figure class="image is-4by3">
                            <img src="{{ item.image | relative_url }}" alt="{{ item.title | escape }}">
                        </figure>
                    </div>
                    {% endif %}
                    <div class="card-content">
                        <div class="media">
                            <div class="media-content">
                                <p class="title is-4">{{ item.title | default: "Untitled" }}</p>
                                <p class="subtitle is-6">
                                    {% if item.author %}By {{ item.author }} · {% endif %}
                                    {% if item.date %}
                                    <time datetime="{{ item.date | date_to_xmlschema }}">{{ item.date | date: "%b %-d, %Y" }}</time>
                                    {% endif %}
                                    {% comment %} Display collection type if not 'posts' and if available {% endcomment %}
                                    {% assign item_collection_label = item.collection | default: "" %}
                                    {% if item_collection_label != "" and item_collection_label != 'posts' %}
                                    · <span class="tag is-light is-capitalized">{{ item_collection_label | replace: "_", " " }}</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="content">
                            {% if item.TLTR %}
                            <div class="notification is-light is-info"><strong>TL;DR:</strong> {{ item.TLTR }}</div>
                            {% elsif item.description %}
                            <p>{{ item.description }}</p>
                            {% endif %}
                            {{ item.excerpt | truncatewords: 25 }} {# Using truncatewords for better control #}
                            {% if item.tags and item.tags.size > 0 %}
                            <div class="tags" style="margin-top: 0.5rem;">
                                {% for tag_item in item.tags %}
                                <span class="tag is-light">{{ tag_item }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="buttons is-right" style="margin-top: 1rem;">
                                <a href="{{ item.url | relative_url }}" class="button is-link is-outlined">
                                    <span>Read More</span><span class="icon is-small"><i class="fas fa-arrow-right"></i></span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="column">
                <p class="has-text-centered">No items found for this page.</p>
            </div>
            {% endif %}
        </div>

        <!-- Pagination Navigation -->
        {% if Paginator.total_pages > 1 %}
        <nav class="pagination is-centered" role="navigation" aria-label="pagination" style="margin-top: 2rem;">
            {% if Paginator.previous_page %}
            <a href="{{ Paginator.previous_page_path | relative_url }}" class="pagination-previous">Previous</a>
            {% else %}
            <a class="pagination-previous" disabled>Previous</a>
            {% endif %}

            {% if Paginator.next_page %}
            <a href="{{ Paginator.next_page_path | relative_url }}" class="pagination-next">Next page</a>
            {% else %}
            <a class="pagination-next" disabled>Next page</a>
            {% endif %}

            <ul class="pagination-list">
                {% for Paginator_page in Paginator.page_trail %}
                <li>
                    <a href="{{ Paginator_page.path | relative_url }}"
                       class="pagination-link {% if Paginator_page.is_current %}is-current{% endif %}"
                       aria-label="Goto page {{ Paginator_page.num }}"
                       {% if Paginator_page.is_current %}aria-current="page"{% endif %}>
                        {{ Paginator_page.num }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </nav>
        {% endif %}

        <div id="no-results" class="notification is-warning is-light" style="display: none; margin-top: 2rem;">
            No items match your search criteria on this page.
        </div>
    </div>
</section>

<!-- Include your original JS for filters -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const authorFilter = document.getElementById('author-filter');
        const categoryFilter = document.getElementById('category-filter');
        const tagFilters = document.querySelectorAll('.tag-filter');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const itemsOnPage = document.querySelectorAll('.item-card');
        const noResults = document.getElementById('no-results');
        const itemListContainer = document.getElementById('item-list');

        function filterItems() {
            const authorValue = authorFilter ? authorFilter.value : 'all';
            const categoryValue = categoryFilter ? categoryFilter.value : 'all';
            const searchValue = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const activeTags = Array.from(document.querySelectorAll('.tag-filter.is-active')).map(tag => tag.dataset.tag);
            let visibleCount = 0;

            itemsOnPage.forEach(item => {
                const itemAuthor = item.dataset.author || "";
                const itemCategories = (item.dataset.category || "").split(' ').filter(Boolean);
                const itemTags = (item.dataset.tags || "").split(' ').filter(Boolean);
                const itemSearch = item.dataset.search || "";

                const authorMatch = authorValue === 'all' || itemAuthor.includes(authorValue);
                const categoryMatch = categoryValue === 'all' || itemCategories.includes(categoryValue);
                const tagMatch = activeTags.length === 0 || activeTags.some(tag => itemTags.includes(tag));
                const searchMatch = searchValue === '' || itemSearch.includes(searchValue);

                if (authorMatch && categoryMatch && tagMatch && searchMatch) {
                    item.style.display = 'block'; // Or 'flex' for Bulma columns
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            if (itemsOnPage.length > 0 && visibleCount === 0) {
                noResults.style.display = 'block';
                if (itemListContainer) itemListContainer.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                if (itemListContainer) itemListContainer.style.display = 'flex'; // Bulma 'columns is-multiline' is flex
            }
        }

        if (authorFilter) authorFilter.addEventListener('change', filterItems);
        if (categoryFilter) categoryFilter.addEventListener('change', filterItems);
        if (searchInput) searchInput.addEventListener('keyup', filterItems);
        if (searchButton) searchButton.addEventListener('click', filterItems);
        tagFilters.forEach(tag => {
            tag.addEventListener('click', function() {
                this.classList.toggle('is-active');
                this.classList.toggle('is-info');
                filterItems();
            });
        });
        // if (itemsOnPage.length > 0) filterItems(); // Initial filter if needed
    });
</script>

<!-- Include your original CSS -->
<style>
    .tag-filter { cursor: pointer; transition: all 0.3s ease; margin-bottom: 0.5rem; margin-right: 0.25rem; }
    .tag-filter:hover { transform: scale(1.05); }
    .card { height: 100%; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .card-content { flex-grow: 1; display: flex; flex-direction: column; }
    .card-content .content { flex-grow: 1; } /* Removed margin-bottom: 1rem to let buttons sit closer if content is short */
    .card-content .content .tags { margin-bottom: 0.75rem; }
    .pagination-link.is-current { background-color: #3273dc; border-color: #3273dc; color: white !important; }
    #no-results { margin-top: 2rem; }
    .is-capitalized { text-transform: capitalize; }
</style>