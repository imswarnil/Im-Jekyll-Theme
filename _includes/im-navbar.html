<nav class="navbar is-fixed-top has-shadow" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a href="{{ site.baseurl }}/" class="navbar-item">
        {% if site.logo %}
          <img src="{{ site.logo | relative_url }}" alt="{{ site.title | escape }} Logo">
        {% endif %}
        <span class="has-text-weight-bold ml-2">{{ site.title }}</span>
      </a>

      <!-- Mobile search & dark toggle -->
      <div class="navbar-item is-hidden-desktop ml-auto">
        <a href="{{ '/search' | relative_url }}" class="navbar-item" aria-label="Search">
          <span class="icon is-medium"><i class="ph ph-magnifying-glass"></i></span>
        </a>
        <a href="#" class="navbar-item" id="mobile-dark-mode-toggle" title="Toggle Dark Mode" role="button">
          <span class="icon is-medium"><i class="ph" id="mobile-theme-icon"></i></span>
        </a>
      </div>

      <!-- Hamburger -->
      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMainMenu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navbarMainMenu" class="navbar-menu">
      <div class="navbar-end">
        {% for item in site.navbar %}
          {% assign item_url_relative = item.link | relative_url %}
          {% assign current_page_url = page.url | remove: "index.html" | default: "/" %}
          {% assign current_item_url = item_url_relative | remove: "index.html" | default: "/" %}
          {% assign is_active = current_page_url == current_item_url and current_item_url != "/#" %}
          {% assign is_active_parent = false %}

          {% if item.dropdown %}
            {% if item.link != "/#" and current_item_url != "/" and current_page_url contains current_item_url %}
              {% assign is_active_parent = true %}
            {% endif %}
            {% for subitem in item.dropdown %}
              {% assign subitem_url = subitem.link | relative_url | remove: "index.html" | default: "/" %}
              {% if current_page_url == subitem_url %}
                {% assign is_active_parent = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}

          {% if item.dropdown %}
            <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link {% if is_active_parent %}is-active{% endif %}"
                {% if item.link != "/#" %}href="{{ item_url_relative }}"{% else %}role="button"{% endif %}>
                {% if item.icon %}
                  <span class="icon"><i class="ph ph-{{ item.icon }}"></i></span>
                {% endif %}
                <span>{{ item.name }}</span>
              </a>
              <div class="navbar-dropdown is-boxed">
                {% for subitem in item.dropdown %}
                  <a class="navbar-item {% if current_page_url == subitem.link | relative_url %}is-active{% endif %}"
                    href="{{ subitem.link | relative_url }}">
                    {% if subitem.icon %}
                      <span class="icon is-small"><i class="ph ph-{{ subitem.icon }}"></i></span>
                    {% endif %}
                    {{ subitem.name }}
                  </a>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <a class="navbar-item {% if is_active %}is-active{% endif %}" href="{{ item_url_relative }}">
              {% if item.icon %}
                <span class="icon"><i class="ph ph-{{ item.icon }}"></i></span>
              {% endif %}
              {{ item.name }}
            </a>
          {% endif %}
        {% endfor %}
      </div>

      <div class="navbar-end is-hidden-touch">
        <a href="{{ '/search' | relative_url }}" class="navbar-item" aria-label="Search">
          <span class="icon is-small"><i class="ph ph-magnifying-glass"></i></span>
        </a>
      </div>
    </div>
  </div>
</nav>
